<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:cc="http://xmlns.jcp.org/jsf/composite"
      xmlns:h="http://xmlns.jcp.org/jsf/html">

  <!--Markdown editor component.-->
  <!--01/23/18 - created-->
  <!--01/15/19 - move to faces-common-->
  <!--03/02/19 - v2.0.0 add extended MD features, file upload support -->

  <!--How to use:-->
  <!--Requires-->
  <!--<script src="https://s3.amazonaws.com/keybridge-cdn/assets/plugin/markdown/2.0.0/markdown-editor.min.js"/>-->
  <!--Includes-->
  <!--File upload javascript-->
  <!--<widget:markdownEditor value="#{editorBean.comment}"/>-->
  <!--IMPORTANT: the markdown text is posted directly to the server (outside of JSF)-->
  <!--and must be manually picked up with the query parameter "markdown"-->

  <!-- INTERFACE -->
  <cc:interface>
    <cc:attribute name="value" required="true" type="java.lang.String" displayName="The text field to edit"/>
    <cc:attribute name="label"  displayName="The component label displayed above the input" />
    <cc:attribute name="description" default="#{cc.resourceBundleMap.memo_markdown_supported}" displayName="A bried description displayed below the input" />
    <cc:attribute name="renderDescription" required="false" type="java.lang.Boolean" default="true" displayName="If a markdown enabled message should be rendered."/>
    <cc:attribute name="rows" default="10" displayName="The number of text rows"/>
    <cc:attribute name="placeholder" displayName="Example text shown in the input" />
    <cc:attribute name="smallText" default="false" type="java.lang.Boolean" displayName="Render the text font smaller"/>
    <cc:attribute name="styleClass" required="false" type="java.lang.String" displayName="Any CSS style class to wrap the file content."/>
    <cc:attribute name="enableExtendedFunctions" type="java.lang.Boolean" default="false" displayName="Show extended function buttons."/>
    <!--fileUploadToken is a JWT identifying the sending application and possibly the user-->
    <cc:attribute name="fileUploadToken" type="java.lang.String" displayName="An upload token, presented by the sending web service on behalf of the user"/>
    <cc:attribute name="fileUploadUrl" type="java.lang.String" displayName="i0i0 file upload endpoint"/>
  </cc:interface>

  <!-- IMPLEMENTATION -->
  <cc:implementation>
    <div id="#{cc.clientId}" class="#{cc.attrs.styleClass} form-group">
      <h:outputLabel for="#{cc.id}-edit" value="#{cc.attrs.label}" rendered="#{cc.attrs.label ne null}" styleClass="d-block"/>
      <div class="card">
        <!--EDIT-->
        <div class="card-header edit-commands">
          <span class="btn-group">
            <span title="Bold" onclick="$('##{cc.id}-edit').mdBold();" class="btn btn-sm btn-default fa fa-bold"/>
            <span title="Italic" onclick="$('##{cc.id}-edit').mdItalic();" class="btn btn-sm btn-default fa fa-italic"/>
            <span title="Underline" onclick="$('##{cc.id}-edit').mdUnderline();" class="btn btn-sm btn-default fa fa-underline"/>
            <h:panelGroup rendered="#{cc.attrs.enableExtendedFunctions}">
              <span title="Strike" onclick="$('##{cc.id}-edit').mdStrikethrough();" class="btn btn-sm btn-default fa fa-strikethrough"/>
              <span title="Superscript" onclick="$('##{cc.id}-edit').mdSuperscript();" class="btn btn-sm btn-default fa fa-superscript"/>
              <span title="Subscript" onclick="$('##{cc.id}-edit').mdSubscript();" class="btn btn-sm btn-default fa fa-subscript"/>
              <span title="Highlight" onclick="$('##{cc.id}-edit').mdHighlight();" class="btn btn-sm btn-default fa fa-highlighter"/>
            </h:panelGroup>
          </span>

          <span class="btn-group">
            <span title="Header 1" onclick="$('##{cc.id}-edit').mdHeader({number: 1, default: ' '});" class="btn btn-sm btn-default fa fa-heading"/>
            <h:panelGroup rendered="#{cc.attrs.enableExtendedFunctions}">
              <span title="Header 2" onclick="$('##{cc.id}-edit').mdHeader({number: 2, default: ' '});" class="btn btn-sm btn-default fa fa-heading text-small"/>
              <span title="Header 3" onclick="$('##{cc.id}-edit').mdHeader({number: 3, default: ' '});" class="btn btn-sm btn-default fa fa-heading" style="font-size: 10px;"/>
            </h:panelGroup>
          </span>

          <span class="btn-group">
            <span title="Bullet list" onclick="$('##{cc.id}-edit').mdBulletList();" class="btn btn-sm btn-default fa fa-list-ul"/>
            <span title="Numbered list" onclick="$('##{cc.id}-edit').mdNumberedList();" class="btn btn-sm btn-default fa fa-list-ol"/>
            <span title="Block quote" onclick="$('##{cc.id}-edit').mdQuote();" class="btn btn-sm btn-default fa fa-quote-left"/>
            <h:panelGroup rendered="#{cc.attrs.enableExtendedFunctions}">
              <span title="Table" onclick="$('##{cc.id}-edit').mdTable();" class="btn btn-sm btn-default fa fa-table"/>
            </h:panelGroup>
          </span>

          <span class="btn-group">
            <span title="Link" onclick="$('##{cc.id}-edit').mdLink();" class="btn btn-sm btn-default fa fa-link"/>
            <h:outputLabel title="Upload file" styleClass="btn btn-sm btn-default fa fa-file-upload my-0" rendered="#{cc.attrs.fileUploadUrl ne null}">
              <input id="#{cc.id}-file-input" name="file" type="file" multiple="true" style="display:none"/>
            </h:outputLabel>
          </span>

          <h:panelGroup styleClass="btn-group" rendered="#{cc.attrs.enableExtendedFunctions}">
            <span title="Inline Code" onclick="$('##{cc.id}-edit').mdCodeInline();" class="btn btn-sm btn-default fa fa-code"/>
            <span title="Code block" onclick="$('##{cc.id}-edit').mdCode();" class="btn btn-sm btn-default fa fa-file-code"/>
            <span title="Macro" onclick="$('##{cc.id}-edit').mdMacro();" class="btn btn-sm btn-default fa fa-magic"/>
            <span title="Insert" onclick="$('##{cc.id}-edit').mdInsert();" class="btn btn-sm btn-default fa fa-plus"/>
            <span title="Delete" onclick="$('##{cc.id}-edit').mdDelete();" class="btn btn-sm btn-default fa fa-minus"/>
            <span title="Equation" onclick="$('##{cc.id}-edit').mdEquationInline();" class="btn btn-sm btn-default fa fa-equals"/>
            <span title="Math block" onclick="$('##{cc.id}-edit').mdEquation();" class="btn btn-sm btn-default fa fa-calculator"/>
            <span title="Chart" onclick="$('##{cc.id}-edit').mdChart();" class="btn btn-sm btn-default fa fa-sitemap"/>
          </h:panelGroup>
        </div>
        <textarea id="#{cc.id}-edit" name="markdown" rows="#{cc.attrs.rows}"
                  placeholder="#{cc.attrs.placeholder}"
                  class="form-control undotted markdown #{cc.attrs.smallText?'text-small':''}"
                  data-provide="markdown">#{cc.attrs.value}</textarea>
      </div>
      <span class="d-block my-1 d-flex justify-content-between">
        <h:outputText value="#{cc.attrs.description}" styleClass="text-small text-muted" rendered="#{cc.attrs.renderDescription}"/>
      </span>
    </div>
    <style type="text/css">
      .dotted { border: dashed 2px  #007bff; }
      .undotted {  border: solid 2px transparent; }
    </style>
    <h:outputScript rendered="#{cc.attrs.fileUploadUrl ne null}">
      //  <![CDATA[
      var totalBytesToUpload=0,totalBytesUploaded=0;function uploadFiles(e,t){totalBytesToUpload=0,totalBytesUploaded=0;for(var o=0;o<t.length;o++)totalBytesToUpload+=t[o].size;for(o=0;o<t.length;o++)console.debug("uploading file",t[o]),uploadOneFile(t[o],e)}function insertUrlIntoText(e,t,o){const n=e.selectionStart,a=e.value.substring(0,n),d=e.value.substring(n);var l="\n"+(isImageFile(t)?"![":"[")+t+"]("+o+")\n";e.value=a+l+d,e.focus(),e.selectionStart=n,e.selectionEnd=n+l.length}function isImageFile(e){return(e=e.toLowerCase()).endsWith("jpg")||e.endsWith("jpeg")||e.endsWith("png")||e.endsWith("gif")||e.endsWith("svg")}function uploadProgressCallback(e,t){console.debug("Upload progress for "+e.name,t.loaded/t.total*100,"(%)"),totalBytesUploaded+=t.loaded,nanobar.go(Math.ceil(100*Math.min(totalBytesUploaded/totalBytesToUpload,1)))}function handleIoioServerResponse(e,t,o){insertUrlIntoText(t,o,JSON.parse(e).url)}function uploadOneFile(e,t){var o=new FormData;o.append("file",e),o.append("contentType",e.type),o.append("size",e.size),o.append("token","#{cc.attrs.fileUploadToken}");var n=new XMLHttpRequest;n.open("POST","#{cc.attrs.fileUploadUrl}"),n.upload.onprogress=function(t){uploadProgressCallback(e,t)},n.onload=function(o){handleIoioServerResponse(n.response,t,e.name)},n.send(o)}document.getElementById("#{cc.id}-file-input").onchange=function(e){console.debug("event=change",e,this.files),uploadFiles(document.getElementById("#{cc.id}-edit"),this.files)},document.getElementById("#{cc.id}-edit").ondrop=function(e){e.preventDefault(),uploadFiles(document.getElementById("#{cc.id}-edit"),e.dataTransfer.files),e.target.classList.add("undotted"),e.target.classList.remove("dotted")},document.getElementById("#{cc.id}-edit").ondragover=function(e){e.preventDefault(),e.target.classList.remove("undotted"),e.target.classList.add("dotted")},document.getElementById("#{cc.id}-edit").ondragleave=function(e){e.target.classList.add("undotted"),e.target.classList.remove("dotted")};
        //      ]]>
  </h:outputScript>
</cc:implementation>
</html>